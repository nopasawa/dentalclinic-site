<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองคิวคลินิกทันตกรรม</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/quill@1.3.6/dist/quill.snow.css">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .view { display: none; }
        .view.active { display: block; }
        .admin-view { display: none; }
        .admin-view.active { display: block; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }
        
        /* Custom Calendar Styles */
        .calendar-day {
            transition: all 0.2s ease;
        }
        .calendar-day.disabled {
            color: #d1d5db; /* gray-400 */
            pointer-events: none;
            text-decoration: line-through;
        }
        .calendar-day.selected {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-radius: 50%;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #4f46e5;
        }
        .calendar-day:not(.disabled):hover {
            background-color: #e0e7ff; /* indigo-100 */
            border-radius: 50%;
        }
        .time-slot {
            transition: all 0.2s ease;
        }
        .time-slot.selected {
            background-color: #4f46e5;
            color: white;
            transform: scale(1.05);
        }
        .time-slot:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .note-icon:hover {
            transform: scale(1.1);
        }
        /* iPadOS-like inputs */
        .modern-input {
            background-color: #f1f5f9; /* slate-100 */
            border: 2px solid transparent;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
        }
        .modern-input:focus {
            outline: none;
            border-color: #6366f1; /* indigo-500 */
            background-color: white;
            box-shadow: 0 0 0 2px #c7d2fe; /* indigo-200 */
        }
        .admin-nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: #475569; /* slate-600 */
            transition: all 0.2s ease;
        }
        .admin-nav-link:hover {
            background-color: #eef2ff; /* indigo-50 */
            color: #4338ca; /* indigo-700 */
        }
        .admin-nav-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 14px 0 rgb(0 0 0 / 10%);
        }
        .pagination-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        .pagination-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .pagination-btn:not(.active):hover {
            background-color: #e0e7ff;
        }
        .pagination-btn:disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }
        .ql-toolbar {
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            border-color: #e2e8f0;
        }
        .ql-container {
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
            border-color: #e2e8f0;
            min-height: 150px;
        }
        .time-slot-setting {
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
            font-weight: 500;
            cursor: pointer;
        }
        .time-slot-setting.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .time-slot-setting:not(.active):hover {
            background-color: #e0e7ff;
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">

        <!-- Loading Spinner -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-white"></div>
        </div>
        
        <!-- Header for navigation -->
        <div id="main-header" class="mb-6 flex justify-between items-center hidden">
             <h1 class="clinic-name text-2xl font-bold text-indigo-600 cursor-pointer" id="home-button">คลินิกทันตกรรม</h1>
             <div id="header-actions"></div>
        </div>

        <!-- Welcome View -->
        <div id="welcome-view" class="view active">
            <div class="bg-white p-8 md:p-12 rounded-3xl shadow-lg text-center max-w-4xl mx-auto">
                <h1 class="clinic-name text-4xl md:text-5xl font-bold text-slate-800 mb-4">คลินิกทันตกรรมยินดีให้บริการ</h1>
                <div id="announcement-section" class="mb-8 p-4 bg-indigo-50 border border-indigo-200 rounded-xl hidden">
                    <h3 class="font-semibold text-indigo-800">ข่าวประชาสัมพันธ์ล่าสุด</h3>
                    <div id="announcement-text" class="text-indigo-700 text-left"></div>
                </div>
                <p class="text-slate-500 mb-10 text-lg">เลือกบริการที่คุณต้องการเพื่อเริ่มต้น</p>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                    <button id="go-to-booking" class="welcome-btn bg-indigo-500 hover:bg-indigo-600">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        จองคิว
                    </button>
                    <button id="go-to-status-check" class="welcome-btn bg-green-500 hover:bg-green-600">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                        ตรวจสอบสถานะ
                    </button>
                    <button id="go-to-news" class="welcome-btn bg-cyan-500 hover:bg-cyan-600">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h2m-4 3h2m-4 3h2"></path></svg>
                        ข่าวประชาสัมพันธ์
                    </button>
                     <button id="go-to-contact" class="welcome-btn bg-sky-500 hover:bg-sky-600">
                         <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                         ติดต่อเรา
                    </button>
                    <button id="go-to-staff-login" class="welcome-btn bg-slate-500 hover:bg-slate-600">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        สำหรับเจ้าหน้าที่
                    </button>
                </div>
            </div>
        </div>
        
        <!-- News Board View -->
        <div id="news-board-view" class="view">
             <div class="bg-white p-8 rounded-2xl shadow-lg max-w-4xl mx-auto">
                 <div class="flex justify-between items-center mb-6">
                     <h2 class="text-3xl font-bold text-slate-800">ข่าวประชาสัมพันธ์</h2>
                     <button id="news-back-to-home" class="text-indigo-600 hover:text-indigo-800 font-semibold">กลับหน้าหลัก</button>
                 </div>
                 <div id="news-list-container" class="space-y-6">
                     <!-- News items will be injected here -->
                 </div>
             </div>
        </div>

        <!-- Patient Booking View -->
        <div id="patient-booking-view" class="view">
             <div class="bg-white p-8 rounded-2xl shadow-lg max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold text-center text-slate-800 mb-8">จองคิวเข้ารับบริการ</h2>
                <form id="booking-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="patient-name" class="block text-sm font-medium text-slate-600 mb-1">ชื่อ-นามสกุล</label>
                            <input type="text" id="patient-name" required class="modern-input w-full">
                        </div>
                        <div>
                            <label for="patient-age" class="block text-sm font-medium text-slate-600 mb-1">อายุ</label>
                            <input type="number" id="patient-age" required class="modern-input w-full">
                        </div>
                        <div>
                            <label for="patient-contact" class="block text-sm font-medium text-slate-600 mb-1">เบอร์โทรศัพท์ (10 หลัก)</label>
                            <input type="tel" id="patient-contact" required class="modern-input w-full" pattern="[0-9]{10}" title="กรุณากรอกเบอร์โทรศัพท์ 10 หลัก">
                        </div>
                         <div>
                            <label for="service" class="block text-sm font-medium text-slate-600 mb-1">เลือกบริการ</label>
                            <select id="service" name="service" required class="modern-input w-full"></select>
                        </div>
                        <div>
                            <label for="treatment-right" class="block text-sm font-medium text-slate-600 mb-1">สิทธิการรักษา</label>
                            <select id="treatment-right" name="treatment-right" required class="modern-input w-full"></select>
                        </div>
                    </div>
                    <div class="border-t border-slate-200 pt-6">
                         <div id="calendar-container">
                            <div class="flex items-center justify-between mb-4">
                                <button type="button" id="prev-month-btn" class="p-2 rounded-full hover:bg-slate-100">&lt;</button>
                                <h3 id="month-year-header" class="text-xl font-semibold text-slate-700"></h3>
                                <button type="button" id="next-month-btn" class="p-2 rounded-full hover:bg-slate-100">&gt;</button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-center font-semibold text-slate-500 mb-2">
                                <div>อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div>ส</div>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center"></div>
                        </div>
                        <div id="time-slots-container" class="mt-6 hidden">
                            <h4 class="font-semibold mb-3 text-slate-700">เลือกเวลา:</h4>
                            <div id="time-slots-grid" class="grid grid-cols-3 md:grid-cols-5 gap-3"></div>
                        </div>
                    </div>
                    <p id="booking-form-message" class="text-center text-red-500 font-medium"></p>
                    <div class="flex flex-col sm:flex-row gap-4">
                         <button type="button" id="cancel-booking-btn" class="w-full text-lg bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-4 rounded-xl transition-all duration-300">ยกเลิก</button>
                        <button type="submit" class="w-full text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-300">ยืนยันการจอง</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Confirmation View -->
        <div id="confirmation-view" class="view">
            <div class="bg-white p-8 md:p-12 rounded-3xl shadow-lg text-center max-w-lg mx-auto">
                <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="mt-6 text-3xl font-bold text-slate-800">จองคิวสำเร็จ!</h2>
                <div class="mt-4 p-4 bg-red-100 border-l-4 red-amber-500 text-red-800 rounded-lg" role="alert">
                    <div class="flex">
                        <div class="py-1">
                            <svg class="w-6 h-6 mr-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="text-left">
                            <p class="font-bold">สำคัญมาก</p>
                            <p class="text-sm">กรุณาบันทึกหน้าจอ (แคปเจอร์รูปหน้าจอ) เพื่อใช้แสดงกับเจ้าหน้าที่แทนบัตรนัด ตามวันที่ และ เวลาที่จองดังกล่าว</p>
                        </div>
                    </div>
                </div>
                
                <div id="booking-details-display" class="mt-6 bg-slate-50 p-6 rounded-xl text-left space-y-2 border border-slate-200">
                    <!-- Booking details will be injected here -->
                </div>

                 <button id="back-to-home-confirm" class="mt-8 w-full text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition">กลับสู่หน้าหลัก</button>
            </div>
        </div>

        <!-- Status Check View -->
        <div id="status-check-view" class="view">
             <div class="bg-white p-8 rounded-2xl shadow-lg max-w-lg mx-auto">
                <h2 class="text-3xl font-bold text-center text-slate-800 mb-8">ตรวจสอบสถานะการจอง</h2>
                <form id="status-check-form" class="space-y-4">
                    <div>
                        <label for="booking-id-input" class="block text-sm font-medium text-slate-600 mb-1">กรอกรหัสการจอง</label>
                        <input type="text" id="booking-id-input" required class="modern-input w-full text-center text-lg tracking-widest">
                    </div>
                    <button type="submit" class="w-full text-lg bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition">ตรวจสอบ</button>
                    <button type="button" id="status-back-to-home" class="w-full text-lg bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-4 rounded-xl transition">กลับหน้าหลัก</button>
                </form>
                <div id="status-result" class="mt-6"></div>
            </div>
        </div>
        
        <!-- Login & Register Views -->
        <div id="login-view" class="view">
             <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-8 mt-10">
                <h2 class="text-3xl font-bold text-center text-slate-800">สำหรับเจ้าหน้าที่</h2>
                <form id="login-form" class="mt-8 space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-slate-600 mb-1">อีเมล</label>
                        <input id="login-email" type="email" required class="modern-input w-full" placeholder="อีเมล">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-slate-600 mb-1">รหัสผ่าน</label>
                        <input id="login-password" type="password" required class="modern-input w-full" placeholder="รหัสผ่าน">
                    </div>
                    <button type="submit" class="w-full text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition">เข้าสู่ระบบ</button>
                    <button type="button" id="login-back-to-home" class="w-full text-lg bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-4 rounded-xl transition">กลับหน้าหลัก</button>
                </form>
                <p id="login-error" class="text-red-500 text-center mt-4 font-semibold"></p>
            </div>
        </div>

        <!-- Admin Dashboard View -->
        <div id="admin-dashboard-view" class="view">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Sidebar -->
                <aside class="md:w-64 bg-white/70 backdrop-blur-lg p-4 rounded-2xl shadow-lg flex flex-col">
                    <h2 id="admin-welcome" class="text-lg font-bold text-slate-800 mb-6 px-2 truncate"></h2>
                    <nav class="flex-grow">
                        <ul class="space-y-2">
                             <li><a href="#" data-view="admin-overview" class="admin-nav-link active">
                                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                                 <span>ภาพรวม</span></a>
                            </li>
                            <li><a href="#" data-view="admin-appointments" class="admin-nav-link">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                <span>จัดการนัดหมาย</span></a>
                            </li>
                             <li><a href="#" data-view="admin-news" class="admin-nav-link">
                                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h2m-4 3h2m-4 3h2"></path></svg>
                                 <span>จัดการข่าวสาร</span></a>
                            </li>
                             <li><a href="#" data-view="admin-inbox" class="admin-nav-link">
                                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                 <span>กล่องข้อความ</span>
                                 <span id="inbox-badge" class="ml-auto bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
                                 </a>
                            </li>
                            <li><a href="#" data-view="admin-settings" class="admin-nav-link">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span>ตั้งค่าคลินิก</span></a>
                            </li>
                        </ul>
                    </nav>
                     <button id="admin-logout" class="w-full mt-8 bg-red-500/90 hover:bg-red-600 text-white font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                         ออกจากระบบ
                     </button>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 space-y-6">
                    <!-- Overview/Analytics View -->
                    <div id="admin-overview-view" class="admin-view active"></div>
                    <!-- Appointments Management View -->
                    <div id="admin-appointments-view" class="admin-view"></div>
                    <!-- News Management View -->
                    <div id="admin-news-view" class="admin-view"></div>
                    <!-- Inbox View -->
                    <div id="admin-inbox-view" class="admin-view"></div>
                    <!-- Settings View -->
                    <div id="admin-settings-view" class="admin-view"></div>
                </main>
            </div>
        </div>
        
        <!-- Modals -->
        <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden p-4"></div>
        <div id="contact-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden p-4"></div>
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden p-4"></div>


    </div>
    
    <script src="https://unpkg.com/quill@1.3.6/dist/quill.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, onSnapshot, updateDoc, serverTimestamp, getDocs, where, deleteDoc, runTransaction, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtOUoFJg_qcGdtMVgHLDAjK1gkk7rKQ7Q",
            authDomain: "demotest-ab5b5.firebaseapp.com",
            projectId: "demotest-ab5b5",
            storageBucket: "demotest-ab5b5.appspot.com",
            messagingSenderId: "280787825559",
            appId: "1:280787825559:web:10f97a5c92578a6b8a4ad2",
            measurementId: "G-T1K3TMVXCV"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let clinicConfig = null;
        let allAppointments = [];
        let allMessages = [];
        let allStaff = [];
        let allNews = [];
        let unsubscribeAllAppointments = null;
        let unsubscribeMessages = null;
        let unsubscribeBookedSlots = null;
        let unsubscribeStaff = null;
        let unsubscribeNews = null;
        let bookedSlots = [];
        let currentDate = new Date();
        let selectedDateForBooking = null;
        let selectedTimeForBooking = null;
        let noteModalApptId = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let announcementEditor;
        let newsEditor;
        const allPossibleTimeSlots = [
            "07:00", "07:20", "07:40", "08:00", "08:20", "08:40",
            "09:00", "09:20", "09:40", "10:00", "10:20", "10:40",
            "11:00", "11:20", "11:40", "13:00", "13:20", "13:40",
            "14:00", "14:20", "14:40", "15:00", "15:20", "15:40",
            "16:00", "16:20", "16:40", "17:00", "17:20", "17:40",
            "18:00", "18:20", "18:40"
        ];


        const DEFAULT_CONFIG = {
            clinicName: "คลินิกทันตกรรม",
            services: ["ตรวจสุขภาพฟัน", "ขูดหินปูน", "อุดฟัน"],
            operatingDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            availableTimeSlots: [
                "09:00", "09:20", "09:40", "10:00", "10:20", "10:40", "11:00", "11:20", "11:40", 
                "13:00", "13:20", "13:40", "14:00", "14:20", "14:40", "15:00", "15:20", "15:40",
                "16:00", "16:20", "16:40"
            ],
            announcement: "",
            announcementBackup: "",
            blockedDates: [],
            treatmentRights: ["สิทธิบัตรทอง", "สิทธิประกันสังคม", "ชำระเงินเอง"],
            contactName: "เจ้าหน้าที่",
            contactPhone: "02-123-4567"
        };
        
        const cssClasses = {
            welcomeBtn: `welcome-btn w-full p-6 text-white font-bold rounded-2xl text-lg transition-all duration-300 shadow-md hover:shadow-lg hover:-translate-y-1`,
        };

        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            document.querySelectorAll('.welcome-btn').forEach(el => el.className = cssClasses.welcomeBtn + ' ' + el.className);
            await loadClinicConfig();
            setupEventListeners();
            history.replaceState({ view: 'welcome-view' }, '', '#welcome-view');
        });
        
        async function loadClinicConfig() {
            showLoading(true);
            try {
                const configRef = doc(db, "clinic_settings", "config");
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) {
                    clinicConfig = { ...DEFAULT_CONFIG, ...configSnap.data() };
                } else {
                    await setDoc(configRef, DEFAULT_CONFIG);
                    clinicConfig = DEFAULT_CONFIG;
                }
                updatePublicUI();
                listenToBookedSlots();
            } catch (error) {
                console.error("Failed to load clinic configuration:", error);
            } finally {
                showLoading(false);
            }
        }
        function updatePublicUI() {
            document.querySelectorAll('.clinic-name').forEach(el => el.textContent = clinicConfig.clinicName);
            const announcementSection = document.getElementById('announcement-section');
            const announcementText = document.getElementById('announcement-text');
            if (clinicConfig.announcementBackup && clinicConfig.announcementBackup.trim() !== '<p><br></p>') {
                announcementText.innerHTML = clinicConfig.announcementBackup;
                announcementSection.classList.remove('hidden');
            } else {
                announcementSection.classList.add('hidden');
            }
            const serviceEl = document.getElementById('service');
            if (serviceEl) {
                serviceEl.innerHTML = clinicConfig.services.map(s => `<option value="${s}">${s}</option>`).join('');
            }
            const treatmentRightEl = document.getElementById('treatment-right');
            if (treatmentRightEl) {
                treatmentRightEl.innerHTML = clinicConfig.treatmentRights.map(r => `<option value="${r}">${r}</option>`).join('');
            }
            setupDateTimePickers();
        }
        function listenToAllAppointments() {
            if (unsubscribeAllAppointments) unsubscribeAllAppointments();
            const q = query(collection(db, "appointments"));
            unsubscribeAllAppointments = onSnapshot(q, (querySnapshot) => {
                allAppointments = [];
                querySnapshot.forEach(doc => allAppointments.push({ id: doc.id, ...doc.data() }));
                renderAdminOverview();
                renderAllAppointmentsTable();
            }, (error) => {
                console.error("Error listening to appointments:", error);
            });
        }
        function listenToBookedSlots() {
            if (unsubscribeBookedSlots) unsubscribeBookedSlots();
            const q = query(collection(db, "booked_slots"));
            unsubscribeBookedSlots = onSnapshot(q, (querySnapshot) => {
                bookedSlots = [];
                querySnapshot.forEach(doc => bookedSlots.push(doc.id));
                if (selectedDateForBooking) {
                    renderTimeSlots(selectedDateForBooking);
                }
            }, (error) => {
                console.error("Error listening to booked slots:", error);
            });
        }
        function listenToMessages() {
            if (unsubscribeMessages) unsubscribeMessages();
            const q = query(collection(db, "messages"));
            unsubscribeMessages = onSnapshot(q, (querySnapshot) => {
                allMessages = [];
                querySnapshot.forEach(doc => allMessages.push({ id: doc.id, ...doc.data() }));
                renderInbox();
            }, (error) => {
                console.error("Error listening to messages:", error);
            });
        }
        function listenToStaff() {
             if (unsubscribeStaff) unsubscribeStaff();
             const q = query(collection(db, "users"), where("role", "==", "staff"));
             unsubscribeStaff = onSnapshot(q, (querySnapshot) => {
                 allStaff = [];
                 querySnapshot.forEach(doc => allStaff.push({ id: doc.id, ...doc.data() }));
                 renderStaffList();
             }, (error) => {
                 console.error("Error listening to staff:", error);
             });
        }
        function listenToNews() {
            if (unsubscribeNews) unsubscribeNews();
            const q = query(collection(db, "news"), orderBy("createdAt", "desc"));
            unsubscribeNews = onSnapshot(q, (querySnapshot) => {
                allNews = [];
                querySnapshot.forEach(doc => allNews.push({ id: doc.id, ...doc.data() }));
                renderAdminNews();
                renderPublicNews();
            }, (error) => {
                console.error("Error listening to news:", error);
            });
        }

        function setupDateTimePickers() {
            if (!clinicConfig) return;
            const calendarGrid = document.getElementById('calendar-grid');
            if (calendarGrid) {
                renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
                renderTimeSlots(null, true);
            }
        }
        function renderCalendar(year, month) {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('month-year-header');
            if(!calendarGrid || !monthYearHeader) return;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            monthYearHeader.textContent = `${firstDay.toLocaleString('th-TH', { month: 'long' })} ${year + 543}`;
            calendarGrid.innerHTML = '';
            for (let i = 0; i < firstDay.getDay(); i++) { calendarGrid.innerHTML += '<div></div>'; }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day, 12); // Use midday to avoid timezone issues
                const today = new Date();
                today.setHours(0,0,0,0);

                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                let classes = 'calendar-day h-10 w-10 flex items-center justify-center cursor-pointer';

                if (date < today || !clinicConfig.operatingDays.includes(dayName) || (clinicConfig.blockedDates && clinicConfig.blockedDates.includes(dateStr))) {
                    classes += ' disabled';
                }
                if (selectedDateForBooking === dateStr) {
                    classes += ' selected';
                }
                calendarGrid.innerHTML += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
            }
        }
        function renderTimeSlots(dateStr, forceRender = false) {
            const timeSlotsContainer = document.getElementById('time-slots-container');
            const timeSlotsGrid = document.getElementById('time-slots-grid');
            if(!timeSlotsContainer || !timeSlotsGrid) return;
            if (!dateStr && !forceRender) {
                timeSlotsContainer.classList.add('hidden');
                return;
            }
            timeSlotsContainer.classList.remove('hidden');
            timeSlotsGrid.innerHTML = '';
            
            const dayBookedSlots = dateStr ? bookedSlots.filter(slotId => slotId.startsWith(dateStr)) : [];
            
            if (!clinicConfig.availableTimeSlots || clinicConfig.availableTimeSlots.length === 0) {
                timeSlotsGrid.innerHTML = '<p class="col-span-full text-slate-500">ไม่มีช่วงเวลาให้บริการ</p>';
                return;
            }

            let hasSlot = false;
            clinicConfig.availableTimeSlots.forEach(timeString => {
                hasSlot = true;
                const slotId = `${dateStr}_${timeString.replace(':', '-')}`;
                const isBooked = dayBookedSlots.includes(slotId);
                let classes = 'time-slot p-2 border border-slate-200 rounded-lg text-center cursor-pointer font-medium';
                if (isBooked) {
                    classes += ' disabled';
                }
                if (selectedTimeForBooking === timeString) {
                    classes += ' selected';
                }
                timeSlotsGrid.innerHTML += `<button type="button" class="${classes}" data-time="${timeString}" ${isBooked ? 'disabled' : ''}>${timeString}</button>`;
            });

             if(!hasSlot) {
                 timeSlotsGrid.innerHTML = '<p class="col-span-full text-slate-500">ไม่มีช่วงเวลาให้บริการ</p>';
            }
        }

        function renderAdminOverview(){
            const container = document.getElementById('admin-overview-view');
            if(!container || !allAppointments) return;
            const todayStr = new Date().toISOString().split('T')[0];
            const todayAppointments = allAppointments.filter(appt => appt.date === todayStr);
            container.innerHTML = `<h3 class="text-2xl font-bold mb-4 text-slate-800">สรุปข้อมูลวันนี้</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-2xl shadow-lg"><h4 class="text-slate-500 font-medium">นัดหมายวันนี้</h4><p id="stats-today-total" class="text-4xl font-bold mt-2 text-indigo-500">${todayAppointments.length}</p></div><div class="bg-white p-6 rounded-2xl shadow-lg"><h4 class="text-slate-500 font-medium">รอการยืนยัน</h4><p id="stats-pending" class="text-4xl font-bold mt-2 text-amber-500">${allAppointments.filter(appt => appt.status === 'pending').length}</p></div><div class="bg-white p-6 rounded-2xl shadow-lg"><h4 class="text-slate-500 font-medium">เสร็จสิ้นแล้ว</h4><p id="stats-completed-today" class="text-4xl font-bold mt-2 text-green-500">${allAppointments.filter(appt => appt.status === 'completed').length}</p></div></div>`;
        }
        function renderAllAppointmentsTable(page = 1) {
            const container = document.getElementById('admin-appointments-view');
            if (!container || !allAppointments) return;

            const visibleAppointments = allAppointments.filter(appt => appt.status !== 'completed');
            visibleAppointments.sort((a,b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));
            
            const totalPages = Math.ceil(visibleAppointments.length / itemsPerPage);
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = page * itemsPerPage;
            const paginatedAppointments = visibleAppointments.slice(startIndex, endIndex);

            let paginationHtml = '';
            if (totalPages > 1) {
                paginationHtml += '<div class="mt-4 flex justify-center items-center gap-2">';
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<button class="pagination-btn ${i === page ? 'active' : ''}" data-page="${i}">${i}</button>`;
                }
                paginationHtml += '</div>';
            }

            container.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-lg"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold text-slate-800">รายการนัดหมายทั้งหมด</h3><button id="export-csv-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Export Report (CSV)</span></button></div><div class="overflow-x-auto"><table class="min-w-full"><thead class="border-b border-slate-200"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">รหัสการจอง</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">วันและเวลา</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ชื่อคนไข้</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">บริการ</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">สิทธิการรักษา</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">สถานะ</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">จัดการ</th></tr></thead><tbody class="divide-y divide-slate-100">${paginatedAppointments.map(appt => { const statusInfo = getStatusInfo(appt.status); const noteIcon = `<svg data-id="${appt.id}" data-note="${appt.note || ''}" class="note-icon cursor-pointer inline-block w-5 h-5 ${appt.note ? 'text-blue-500' : 'text-gray-400'}" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a2 2 0 012-2h2.586l-4 4H5zM3 15a2 2 0 012-2h9.586l-2.293 2.293A1 1 0 0112 16H5a2 2 0 01-2-2z"></path></svg>`; return `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-500">${appt.bookingId}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${new Date(appt.date).toLocaleDateString('th-TH')} ${appt.time}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${appt.patientName} ${noteIcon}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${appt.service}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${appt.treatmentRight || '-'}</td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.bg} ${statusInfo.text}">${translateStatus(appt.status)}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2"><button data-id="${appt.id}" data-status="confirmed" class="update-status-btn text-green-600 hover:text-green-900 ${appt.status !== 'pending' ? 'hidden' : ''}">ยืนยัน</button><button data-id="${appt.id}" data-status="completed" class="update-status-btn text-blue-600 hover:text-blue-900 ${appt.status !== 'confirmed' ? 'hidden' : ''}">เสร็จสิ้น</button><button data-id="${appt.id}" data-status="cancelled" class="update-status-btn text-red-600 hover:text-red-900 ${['completed', 'cancelled'].includes(appt.status) ? 'hidden' : ''}">ยกเลิก</button></td></tr>`; }).join('')}</tbody></table></div>${paginationHtml}</div>`;
        }
        function renderInbox(page = 1) {
            const container = document.getElementById('admin-inbox-view');
            if (!container || !allMessages) return;
            allMessages.sort((a, b) => {
                const dateA = a.createdAt?.toDate() || new Date(0);
                const dateB = b.createdAt?.toDate() || new Date(0);
                return dateB - dateA;
            });

            const totalPages = Math.ceil(allMessages.length / itemsPerPage);
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = page * itemsPerPage;
            const paginatedMessages = allMessages.slice(startIndex, endIndex);

            let paginationHtml = '';
            if (totalPages > 1) {
                paginationHtml += '<div class="mt-4 flex justify-center items-center gap-2">';
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<button class="pagination-btn ${i === page ? 'active' : ''}" data-page="${i}">${i}</button>`;
                }
                paginationHtml += '</div>';
            }

            const badge = document.getElementById('inbox-badge');
            if (badge) {
                if (allMessages.length > 0) {
                    badge.textContent = allMessages.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
            container.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-2xl font-bold mb-4 text-slate-800">กล่องข้อความ</h3><div class="space-y-4">${allMessages.length === 0 ? '<p class="text-slate-500 text-center">ยังไม่มีข้อความ</p>' : 
            paginatedMessages.map(msg => `<div class="border border-slate-200 p-4 rounded-xl"><div class="flex justify-between items-start"><div><p class="font-bold text-slate-800">${msg.senderName}</p><p class="text-sm text-slate-500">${msg.senderContact}</p></div><div class="text-right flex-shrink-0 ml-4"><p class="text-xs text-slate-400">${msg.createdAt ? msg.createdAt.toDate().toLocaleString('th-TH') : 'กำลังส่ง...'}</p><button data-id="${msg.id}" class="delete-message-btn text-red-500 text-xs hover:underline mt-1">ลบ</button></div></div><p class="mt-2 text-slate-700 whitespace-pre-wrap">${msg.message}</p></div>`).join('')}</div>${paginationHtml}</div>`;
        }
        function renderPublicNews() {
            const container = document.getElementById('news-list-container');
            if (!container) return;
            if (allNews.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center">ยังไม่มีข่าวประชาสัมพันธ์</p>';
                return;
            }
            container.innerHTML = allNews.map(news => `
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <div class="p-6">
                        <p class="text-sm text-slate-500 mb-2">${news.createdAt ? news.createdAt.toDate().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) : ''}</p>
                        <h3 class="text-2xl font-bold text-slate-800 mb-4">${news.title}</h3>
                        <div class="prose max-w-none text-slate-700">${news.content}</div>
                    </div>
                </div>
            `).join('');
        }
        function renderAdminNews() {
            const container = document.getElementById('admin-news-view');
            if (!container) return;
            const formHtml = `
                <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                    <h3 class="text-2xl font-bold mb-4 text-slate-800">สร้างข่าวประชาสัมพันธ์ใหม่</h3>
                    <form id="news-form" class="space-y-4">
                        <div>
                            <label for="news-title" class="block text-sm font-medium text-slate-600 mb-1">หัวข้อข่าว</label>
                            <input type="text" id="news-title" required class="modern-input w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">เนื้อหา</label>
                            <div id="news-editor-container"></div>
                        </div>
                        <button type="submit" class="w-full text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl">เผยแพร่ข่าว</button>
                    </form>
                </div>
            `;
            const listHtml = `
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                     <h3 class="text-2xl font-bold mb-4 text-slate-800">รายการข่าวทั้งหมด</h3>
                     <div id="admin-news-list" class="space-y-3">
                         ${allNews.length === 0 ? '<p class="text-slate-500">ยังไม่มีข่าวที่สร้าง</p>' : allNews.map(news => `
                             <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                 <div>
                                     <p class="font-semibold text-slate-800">${news.title}</p>
                                     <p class="text-xs text-slate-500">${news.createdAt ? news.createdAt.toDate().toLocaleDateString('th-TH') : ''}</p>
                                 </div>
                                 <button data-id="${news.id}" class="delete-news-btn text-red-500 hover:text-red-700 font-semibold">ลบ</button>
                             </div>
                         `).join('')}
                     </div>
                </div>
            `;
            container.innerHTML = formHtml + listHtml;
            // Initialize Quill editor
            newsEditor = new Quill('#news-editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                    ]
                }
            });
        }
        function openContactModal() {
            const modal = document.getElementById('contact-modal');
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md">
                    <h3 class="text-xl font-semibold mb-2 text-slate-800">ติดต่อเรา</h3>
                    <div class="bg-slate-100 p-4 rounded-lg mb-4">
                        <p><strong>ผู้ติดต่อ:</strong> <span id="contact-modal-name">${clinicConfig.contactName}</span></p>
                        <p><strong>เบอร์โทรศัพท์:</strong> <span id="contact-modal-phone">${clinicConfig.contactPhone}</span></p>
                    </div>
                    <form id="contact-form" class="space-y-4">
                        <div>
                            <label for="contact-sender-name" class="block text-sm font-medium text-slate-600 mb-1">ชื่อของคุณ</label>
                            <input type="text" id="contact-sender-name" required class="modern-input w-full">
                        </div>
                        <div>
                            <label for="contact-sender-contact" class="block text-sm font-medium text-slate-600 mb-1">เบอร์โทรศัพท์สำหรับติดต่อกลับ (10 หลัก)</label>
                            <input type="tel" id="contact-sender-contact" required class="modern-input w-full" pattern="[0-9]{10}" title="กรุณากรอกเบอร์โทรศัพท์ 10 หลัก">
                        </div>
                         <div>
                            <label for="contact-message" class="block text-sm font-medium text-slate-600 mb-1">ข้อความ</label>
                            <textarea id="contact-message" rows="4" required class="modern-input w-full"></textarea>
                        </div>
                        <p id="contact-form-success" class="text-green-600 text-center font-semibold"></p>
                        <div class="mt-4 flex justify-end gap-3">
                            <button type="button" class="modal-close-btn px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-lg transition">ปิด</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">ส่งข้อความ</button>
                        </div>
                    </form>
                </div>`;
            modal.classList.remove('hidden');
        }
        function openNoteModal(apptId, currentNote) {
            noteModalApptId = apptId;
            const modal = document.getElementById('note-modal');
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md">
                    <h3 class="text-xl font-semibold mb-4 text-slate-800">บันทึกสำหรับนัดหมาย</h3>
                    <textarea id="note-textarea" class="modern-input w-full h-32">${currentNote || ''}</textarea>
                    <div class="mt-4 flex justify-end gap-3">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-lg transition">ปิด</button>
                        <button type="button" id="save-note-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">บันทึก</button>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
        }

        function showConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                    <h3 class="text-xl font-bold mb-4 text-slate-800">${title}</h3>
                    <p class="text-slate-600 mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-cancel-btn" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-lg transition">ยกเลิก</button>
                        <button id="confirm-ok-btn" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition">ยืนยัน</button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            document.getElementById('confirm-ok-btn').onclick = () => {
                onConfirm();
                modal.classList.add('hidden');
            };
            document.getElementById('confirm-cancel-btn').onclick = () => {
                modal.classList.add('hidden');
            };
        }

        function populateSettingsForm() {
            const container = document.getElementById('admin-settings-view');
            if (!container || !clinicConfig) return;
            const formHtml = `
             <div class="bg-white p-6 rounded-2xl shadow-lg">
                 <h3 class="text-2xl font-bold mb-6 text-slate-800">ตั้งค่าคลินิก</h3>
                 <div class="space-y-10">
                     <form id="settings-form" class="space-y-10">
                         <div class="space-y-4">
                             <h4 class="font-semibold text-lg text-slate-700 border-b pb-2">ข้อมูลการติดต่อ</h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                     <label for="contact-name-input" class="block text-sm font-medium text-slate-600 mb-1">ชื่อผู้ติดต่อ</label>
                                     <input type="text" id="contact-name-input" class="modern-input w-full">
                                 </div>
                                 <div>
                                     <label for="contact-phone-input" class="block text-sm font-medium text-slate-600 mb-1">เบอร์โทรศัพท์ติดต่อ</label>
                                     <input type="text" id="contact-phone-input" class="modern-input w-full">
                                 </div>
                             </div>
                         </div>
                         <div class="space-y-4">
                             <h4 class="font-semibold text-lg text-slate-700 border-b pb-2">จัดการวันหยุดพิเศษ</h4>
                             <div id="blocked-dates-list" class="space-y-2"></div>
                             <div class="flex items-center gap-3">
                                 <input type="date" id="new-blocked-date-input" class="modern-input flex-grow">
                                 <button type="button" id="add-blocked-date-btn" class="bg-indigo-600 text-white px-4 py-2.5 rounded-lg font-semibold">เพิ่มวันหยุด</button>
                             </div>
                         </div>
                         <div class="space-y-4">
                              <h4 class="font-semibold text-lg text-slate-700 border-b pb-2">ข้อมูลทั่วไป</h4>
                             <div>
                                 <label for="clinic-name-input" class="block text-sm font-medium text-slate-600 mb-1">ชื่อคลินิก</label>
                                 <input type="text" id="clinic-name-input" class="modern-input w-full">
                             </div>
                             <div>
                                 <label for="announcement-backup-input" class="block text-sm font-medium text-slate-600 mb-1">ข่าวประชาสัมพันธ์ (สำรอง)</label>
                                 <div id="announcement-editor-container"></div>
                             </div>
                         </div>
                         <div class="space-y-4">
                             <h4 class="font-semibold text-lg text-slate-700 border-b pb-2">วันและเวลาทำการ</h4>
                             <div>
                                 <label class="block text-sm font-medium text-slate-600 mb-2">วันที่เปิดให้บริการ</label>
                                 <div id="operating-days-inputs" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                             </div>
                             <div>
                                 <label class="block text-sm font-medium text-slate-600 mb-2">เลือกช่วงเวลาที่เปิดให้บริการ (ช่วงละ 20 นาที)</label>
                                 <div id="time-slots-settings-grid" class="mt-2 grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-2">
                                     <!-- Time slots will be injected here -->
                                 </div>
                             </div>
                         </div>
                         <div class="space-y-4">
                              <h4 class="font-semibold text-lg text-slate-700 border-b pb-2">จัดการบริการ</h4>
                              <div id="services-list" class="space-y-2"></div>
                              <div class="flex gap-3">
                                  <input type="text" id="new-service-input" placeholder="เพิ่มบริการใหม่" class="modern-input flex-grow">
                                  <button type="button" id="add-service-btn" class="bg-indigo-600 text-white px-4 py-2.5 rounded-lg font-semibold">เพิ่ม</button>
                              </div>
                         </div>
                         <div class="space-y-4">
                            <h4 class="font-semibold text-lg text-slate-700 border-b pb-2">จัดการสิทธิการรักษา</h4>
                            <div id="treatment-rights-list" class="space-y-2"></div>
                            <div class="flex gap-3">
                                <input type="text" id="new-treatment-right-input" placeholder="เพิ่มสิทธิการรักษาใหม่" class="modern-input flex-grow">
                                <button type="button" id="add-treatment-right-btn" class="bg-indigo-600 text-white px-4 py-2.5 rounded-lg font-semibold">เพิ่ม</button>
                            </div>
                        </div>
                         <button type="submit" class="w-full text-lg bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition">บันทึกการตั้งค่า</button>
                     </form>
                     <div class="space-y-4">
                         <h4 class="font-semibold text-lg text-slate-700 border-b pb-2">จัดการเจ้าหน้าที่</h4>
                         <div id="staff-list" class="space-y-3"></div>
                         <div class="p-4 border border-slate-200 rounded-xl mt-4 space-y-3">
                             <h5 class="font-semibold text-md text-slate-600">เพิ่มเจ้าหน้าที่ใหม่</h5>
                             <form id="add-staff-form" class="space-y-3">
                                 <input type="text" id="new-staff-name" placeholder="ชื่อ-นามสกุล" required class="modern-input w-full">
                                 <input type="email" id="new-staff-email" placeholder="อีเมล" required class="modern-input w-full">
                                 <input type="password" id="new-staff-password" placeholder="รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)" required class="modern-input w-full">
                                 <button type="submit" class="w-full bg-green-500 text-white py-2.5 rounded-lg font-semibold">เพิ่มเจ้าหน้าที่</button>
                                 <p id="add-staff-error" class="text-red-500 text-sm text-center"></p>
                             </form>
                         </div>
                     </div>
                 </div>
             </div>`;
            container.innerHTML = formHtml;
            document.getElementById('clinic-name-input').value = clinicConfig.clinicName;
            
            announcementEditor = new Quill('#announcement-editor-container', {
                theme: 'snow',
                 modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                    ]
                }
            });
            if(clinicConfig.announcementBackup) {
                announcementEditor.root.innerHTML = clinicConfig.announcementBackup;
            }

            document.getElementById('contact-name-input').value = clinicConfig.contactName;
            document.getElementById('contact-phone-input').value = clinicConfig.contactPhone;
            const daysContainer = document.getElementById('operating-days-inputs');
            const days = { Monday:'จันทร์', Tuesday:'อังคาร', Wednesday:'พุธ', Thursday:'พฤหัสบดี', Friday:'ศุกร์', Saturday:'เสาร์', Sunday:'อาทิตย์' };
            daysContainer.innerHTML = Object.entries(days).map(([eng, th]) => `<label class="flex items-center space-x-2"><input type="checkbox" value="${eng}" class="operating-day-cb rounded h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-slate-300" ${clinicConfig.operatingDays.includes(eng) ? 'checked' : ''}><span class="text-slate-700">${th}</span></label>`).join('');
            renderBlockedDatesList();
            renderServicesList();
            renderTreatmentRightsList();
            renderStaffList();
            renderTimeSlotSettings();
        }

        function renderBlockedDatesList() {
            const listContainer = document.getElementById('blocked-dates-list');
            if(!listContainer) return;
            if(!clinicConfig.blockedDates) clinicConfig.blockedDates = [];
            listContainer.innerHTML = clinicConfig.blockedDates.sort().map(date => `<div class="flex items-center justify-between p-2 bg-slate-100 rounded-lg"><span class="font-medium">${new Date(date + 'T12:00:00').toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</span><button type="button" data-date="${date}" class="delete-blocked-date-btn text-red-500 hover:text-red-700 font-bold">ลบ</button></div>`).join('') || '<p class="text-slate-500 text-sm">ยังไม่มีวันหยุดพิเศษ</p>';
        }
        function renderServicesList() {
            const listContainer = document.getElementById('services-list');
            listContainer.innerHTML = clinicConfig.services.map((service, index) => `<div class="flex items-center justify-between p-2 bg-slate-100 rounded-lg"><input type="text" value="${service}" data-index="${index}" class="service-item-input bg-transparent border-0 focus:ring-0 w-full font-medium"><button type="button" data-index="${index}" class="delete-service-btn text-red-500 hover:text-red-700 font-bold">ลบ</button></div>`).join('');
        }
        function renderTreatmentRightsList() {
            const listContainer = document.getElementById('treatment-rights-list');
            if(!listContainer) return;
            if(!clinicConfig.treatmentRights) clinicConfig.treatmentRights = [];
            listContainer.innerHTML = clinicConfig.treatmentRights.map((right, index) => `<div class="flex items-center justify-between p-2 bg-slate-100 rounded-lg"><input type="text" value="${right}" data-index="${index}" class="treatment-right-item-input bg-transparent border-0 focus:ring-0 w-full font-medium"><button type="button" data-index="${index}" class="delete-treatment-right-btn text-red-500 hover:text-red-700 font-bold">ลบ</button></div>`).join('');
        }
        function renderStaffList() {
            const container = document.getElementById('staff-list');
            if(!container || !allStaff) return;
            const currentUser = auth.currentUser;
            container.innerHTML = allStaff.map(staff => `
                <div class="staff-item flex items-center justify-between p-3 bg-slate-50 rounded-lg" data-id="${staff.id}">
                    <div class="flex-grow">
                        <input type="text" value="${staff.fullName}" class="staff-name-input bg-transparent border-0 focus:ring-0 w-full font-semibold" readonly>
                        <p class="text-sm text-slate-500 pl-1">${staff.email}</p>
                    </div>
                    <div class="staff-actions flex items-center gap-2">
                        ${currentUser && currentUser.uid !== staff.id ? `
                        <button class="edit-staff-btn p-1 text-slate-500 hover:text-indigo-600">
                           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                        </button>
                        <button class="delete-staff-btn p-1 text-slate-500 hover:text-red-600">
                           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        function renderTimeSlotSettings() {
            const container = document.getElementById('time-slots-settings-grid');
            if (!container) return;

            if (!clinicConfig.availableTimeSlots) {
                clinicConfig.availableTimeSlots = [];
            }

            container.innerHTML = allPossibleTimeSlots.map(time => {
                const isActive = clinicConfig.availableTimeSlots.includes(time);
                return `<button type="button" data-time="${time}" class="time-slot-setting p-2 rounded-lg ${isActive ? 'active' : ''}">${time}</button>`;
            }).join('');
        }

        function setupEventListeners() {
            document.getElementById('go-to-booking').addEventListener('click', () => showView('patient-booking-view'));
            document.getElementById('go-to-status-check').addEventListener('click', () => { showView('status-check-view'); });
            document.getElementById('go-to-staff-login').addEventListener('click', () => showView('login-view'));
            document.getElementById('go-to-news').addEventListener('click', () => showView('news-board-view'));
            document.getElementById('news-back-to-home').addEventListener('click', goHome);
            document.getElementById('go-to-contact').addEventListener('click', openContactModal);
            document.getElementById('home-button').addEventListener('click', goHome);
            document.getElementById('back-to-home-confirm').addEventListener('click', goHome);
            document.getElementById('status-back-to-home').addEventListener('click', goHome);
            document.getElementById('login-back-to-home').addEventListener('click', goHome);

            document.body.addEventListener('click', (e) => {
                const modalCloseBtn = e.target.closest('.modal-close-btn');
                if (modalCloseBtn) {
                    modalCloseBtn.closest('.fixed').classList.add('hidden');
                }
                if(e.target.id === 'cancel-booking-btn') {
                    document.getElementById('booking-form').reset();
                    selectedDateForBooking = null;
                    selectedTimeForBooking = null;
                    goHome();
                }
                const editStaffBtn = e.target.closest('.edit-staff-btn');
                if (editStaffBtn) {
                    const item = editStaffBtn.closest('.staff-item');
                    const input = item.querySelector('.staff-name-input');
                    const isEditing = editStaffBtn.dataset.editing === 'true';

                    if (isEditing) { // Save mode
                        input.setAttribute('readonly', true);
                        input.classList.remove('bg-white', 'ring-2', 'ring-indigo-300', 'rounded-md');
                        editStaffBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>`;
                        editStaffBtn.dataset.editing = 'false';
                        // Save to Firestore
                        const staffId = item.dataset.id;
                        const newName = input.value.trim();
                        if (newName) {
                            updateDoc(doc(db, "users", staffId), { fullName: newName });
                        }
                    } else { // Edit mode
                        input.removeAttribute('readonly');
                        input.classList.add('bg-white', 'ring-2', 'ring-indigo-300', 'rounded-md');
                        input.focus();
                        editStaffBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`; // Save icon
                        editStaffBtn.dataset.editing = 'true';
                    }
                }
                const deleteStaffBtn = e.target.closest('.delete-staff-btn');
                if (deleteStaffBtn) {
                    const staffId = deleteStaffBtn.closest('.staff-item').dataset.id;
                    showConfirmationModal(
                        'ยืนยันการลบ',
                        'คุณแน่ใจหรือไม่ว่าต้องการลบบัญชีเจ้าหน้าที่นี้? การกระทำนี้ไม่สามารถย้อนกลับได้',
                        () => {
                            deleteDoc(doc(db, "users", staffId));
                        }
                    );
                }
                const timeSlotSettingBtn = e.target.closest('.time-slot-setting');
                if (timeSlotSettingBtn) {
                    const time = timeSlotSettingBtn.dataset.time;
                    if (!clinicConfig.availableTimeSlots) {
                        clinicConfig.availableTimeSlots = [];
                    }
                    const index = clinicConfig.availableTimeSlots.indexOf(time);
                    if (index > -1) {
                        clinicConfig.availableTimeSlots.splice(index, 1);
                        timeSlotSettingBtn.classList.remove('active');
                    } else {
                        clinicConfig.availableTimeSlots.push(time);
                        clinicConfig.availableTimeSlots.sort();
                        timeSlotSettingBtn.classList.add('active');
                    }
                }
            });

            document.body.addEventListener('submit', (e) => {
                if (e.target.id === 'login-form') handleLogin(e);
                if (e.target.id === 'booking-form') handleBookingSubmit(e);
                if (e.target.id === 'status-check-form') handleStatusCheck(e);
                if (e.target.id === 'settings-form') handleSettingsSubmit(e);
                if (e.target.id === 'contact-form') handleContactSubmit(e);
                if (e.target.id === 'add-staff-form') handleAddStaff(e);
                if (e.target.id === 'news-form') handleNewsSubmit(e);
            });

            document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
            document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
            document.getElementById('calendar-grid').addEventListener('click', (e) => {
                if (e.target.classList.contains('calendar-day') && !e.target.classList.contains('disabled')) {
                    selectedDateForBooking = e.target.dataset.date;
                    selectedTimeForBooking = null;
                    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
                    renderTimeSlots(selectedDateForBooking);
                }
            });
            document.getElementById('time-slots-grid').addEventListener('click', (e) => {
                const button = e.target.closest('.time-slot');
                if (button && !button.disabled) {
                    selectedTimeForBooking = button.dataset.time;
                    document.querySelectorAll('.time-slot').forEach(ts => ts.classList.remove('selected'));
                    button.classList.add('selected');
                }
            });
            const statusResultEl = document.getElementById('status-result');
            if (statusResultEl) {
                statusResultEl.addEventListener('click', async (e) => {
                    if (e.target.id === 'patient-cancel-btn') {
                        const apptId = e.target.dataset.id;
                        const slotId = e.target.dataset.slotId;
                         showConfirmationModal(
                             'ยืนยันการยกเลิก',
                             'คุณแน่ใจหรือไม่ว่าต้องการยกเลิกนัดหมายนี้?',
                              async () => {
                                 showLoading(true);
                                 try {
                                     await runTransaction(db, async (transaction) => {
                                         const apptRef = doc(db, "appointments", apptId);
                                         const slotRef = doc(db, "booked_slots", slotId);
                                         transaction.update(apptRef, { status: 'cancelled' });
                                         transaction.delete(slotRef);
                                     });
                                     statusResultEl.innerHTML = '<p class="text-green-600 text-center font-semibold">ยกเลิกนัดหมายสำเร็จแล้ว</p>';
                                 } catch (error) {
                                     console.error("Cancellation error:", error);
                                     statusResultEl.innerHTML = '<p class="text-red-500 text-center font-semibold">เกิดข้อผิดพลาดในการยกเลิก</p>';
                                 } finally {
                                     showLoading(false);
                                 }
                             }
                         );
                    }
                });
            }
            document.getElementById('admin-logout').addEventListener('click', () => signOut(auth));
            const adminNav = document.querySelector('aside nav');
            if(adminNav) {
                adminNav.addEventListener('click', (e) => {
                    const link = e.target.closest('.admin-nav-link');
                    if (link) {
                        e.preventDefault();
                        currentPage = 1;
                        document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        document.querySelectorAll('.admin-view').forEach(v => v.classList.remove('active'));
                        document.getElementById(link.dataset.view + '-view').classList.add('active');
                        if (link.dataset.view === 'admin-settings') populateSettingsForm();
                        if (link.dataset.view === 'admin-appointments') renderAllAppointmentsTable();
                        if (link.dataset.view === 'admin-inbox') renderInbox();
                        if (link.dataset.view === 'admin-overview') renderAdminOverview();
                        if (link.dataset.view === 'admin-news') renderAdminNews();
                    }
                });
            }
            document.body.addEventListener('click', (e) => {
                const updateBtn = e.target.closest('.update-status-btn');
                const noteIcon = e.target.closest('.note-icon');
                const addBlockedDateBtn = e.target.id === 'add-blocked-date-btn';
                const deleteBlockedDateBtn = e.target.closest('.delete-blocked-date-btn');
                const addServiceBtn = e.target.id === 'add-service-btn';
                const deleteServiceBtn = e.target.closest('.delete-service-btn');
                const addTreatmentRightBtn = e.target.id === 'add-treatment-right-btn';
                const deleteTreatmentRightBtn = e.target.closest('.delete-treatment-right-btn');
                const deleteMessageBtn = e.target.closest('.delete-message-btn');
                const saveNoteBtn = e.target.id === 'save-note-btn';
                const exportCsvBtn = e.target.closest('#export-csv-btn');
                const deleteNewsBtn = e.target.closest('.delete-news-btn');

                if (updateBtn) updateDoc(doc(db, "appointments", updateBtn.dataset.id), { status: updateBtn.dataset.status });
                if (noteIcon) openNoteModal(noteIcon.dataset.id, noteIcon.dataset.note);
                if (addServiceBtn) {
                    const input = document.getElementById('new-service-input');
                    if (input && input.value.trim()) {
                        clinicConfig.services.push(input.value.trim());
                        input.value = '';
                        renderServicesList();
                    }
                }
                if (deleteServiceBtn) {
                    const index = deleteServiceBtn.dataset.index;
                    clinicConfig.services.splice(index, 1);
                    renderServicesList();
                }
                if (addTreatmentRightBtn) {
                    const input = document.getElementById('new-treatment-right-input');
                    if (input && input.value.trim()) {
                        if(!clinicConfig.treatmentRights) clinicConfig.treatmentRights = [];
                        clinicConfig.treatmentRights.push(input.value.trim());
                        input.value = '';
                        renderTreatmentRightsList();
                    }
                }
                if (deleteTreatmentRightBtn) {
                    const index = deleteTreatmentRightBtn.dataset.index;
                    clinicConfig.treatmentRights.splice(index, 1);
                    renderTreatmentRightsList();
                }
                if (addBlockedDateBtn) {
                     const dateInput = document.getElementById('new-blocked-date-input');
                    if (dateInput && dateInput.value && !clinicConfig.blockedDates.includes(dateInput.value)) {
                        clinicConfig.blockedDates.push(dateInput.value);
                        renderBlockedDatesList();
                    }
                    if(dateInput) dateInput.value = '';
                }
                if(deleteBlockedDateBtn) {
                    const date = deleteBlockedDateBtn.dataset.date;
                    clinicConfig.blockedDates = clinicConfig.blockedDates.filter(d => d !== date);
                    renderBlockedDatesList();
                }
                if (deleteMessageBtn) {
                    showConfirmationModal('ยืนยันการลบ', 'คุณแน่ใจหรือไม่ว่าต้องการลบข้อความนี้?', () => {
                        deleteDoc(doc(db, "messages", deleteMessageBtn.dataset.id));
                    });
                }
                if (saveNoteBtn) {
                    const note = document.getElementById('note-textarea').value;
                    updateDoc(doc(db, "appointments", noteModalApptId), { note: note });
                    document.getElementById('note-modal').classList.add('hidden');
                }
                if(exportCsvBtn) exportToCsv();
                if(deleteNewsBtn) {
                    const newsId = deleteNewsBtn.dataset.id;
                     showConfirmationModal('ยืนยันการลบ', 'คุณแน่ใจหรือไม่ว่าต้องการลบข่าวนี้?', () => {
                         deleteDoc(doc(db, "news", newsId));
                    });
                }

                const paginationBtn = e.target.closest('.pagination-btn');
                if(paginationBtn) {
                    const page = parseInt(paginationBtn.dataset.page);
                    const parentView = paginationBtn.closest('.admin-view');
                    if (parentView.id === 'admin-appointments-view') {
                        renderAllAppointmentsTable(page);
                    } else if (parentView.id === 'admin-inbox-view') {
                        renderInbox(page);
                    }
                }
            });
            document.body.addEventListener('change', (e) => {
                if(e.target.classList.contains('service-item-input')) {
                    const index = e.target.dataset.index;
                    clinicConfig.services[index] = e.target.value.trim();
                }
                if(e.target.classList.contains('treatment-right-item-input')) {
                    const index = e.target.dataset.index;
                    clinicConfig.treatmentRights[index] = e.target.value.trim();
                }
            });
        }
        async function handleLogin(e) { e.preventDefault(); showLoading(true); const errEl = document.getElementById('login-error'); errEl.textContent = ''; try { const userCredential = await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); const user = userCredential.user; const userDocRef = doc(db, "users", user.uid); const userDoc = await getDoc(userDocRef); if (userDoc.exists() && userDoc.data().role === 'staff') { /* Success, onAuthStateChanged will handle UI */ } else { await signOut(auth); errEl.textContent = "บัญชีนี้ไม่มีสิทธิ์ในการเข้าถึง"; } } catch (error) { errEl.textContent = "อีเมลหรือรหัสผ่านไม่ถูกต้อง"; } finally { showLoading(false); } }
        async function handleAddStaff(e) {
            e.preventDefault();
            const errEl = document.getElementById('add-staff-error');
            const name = document.getElementById('new-staff-name').value;
            const email = document.getElementById('new-staff-email').value;
            const password = document.getElementById('new-staff-password').value;
            errEl.textContent = '';

            if (password.length < 6) {
                errEl.textContent = 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
                return;
            }
            showLoading(true);
            try {
                const tempApp = initializeApp(firebaseConfig, 'temp-app-for-registration');
                const tempAuth = getAuth(tempApp);
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                const newUser = userCredential.user;

                await setDoc(doc(db, "users", newUser.uid), {
                    fullName: name,
                    email: email,
                    role: 'staff'
                });
                
                await signOut(tempAuth);
                e.target.reset();
            } catch (error) {
                console.error("Error adding new staff: ", error);
                errEl.textContent = "เกิดข้อผิดพลาด: " + error.message;
            } finally {
                showLoading(false);
            }
        }
        async function handleBookingSubmit(e) {
            e.preventDefault();
            const msgEl = document.getElementById('booking-form-message');
            msgEl.textContent = '';
            const patientName = sanitizeHTML(document.getElementById('patient-name').value);
            const patientContact = sanitizeHTML(document.getElementById('patient-contact').value);
            const patientAge = sanitizeHTML(document.getElementById('patient-age').value);
            const phoneRegex = /^[0-9]{10}$/;
            if (!phoneRegex.test(patientContact)) {
                msgEl.textContent = 'กรุณากรอกเบอร์โทรศัพท์ 10 หลักให้ถูกต้อง';
                return;
            }
            if (!patientName || !patientContact || !patientAge) { msgEl.textContent = 'กรุณากรอกข้อมูลให้ครบถ้วน'; return; }
            if (!selectedDateForBooking || !selectedTimeForBooking) { msgEl.textContent = 'กรุณาเลือกวันและเวลา'; return; }
            
            showLoading(true);

            try {
                const q = query(collection(db, "appointments"), where("date", "==", selectedDateForBooking));
                const querySnapshot = await getDocs(q);
                const queueNumber = querySnapshot.size + 1;

                const slotId = `${selectedDateForBooking}_${selectedTimeForBooking.replace(':', '-')}`;
                const slotRef = doc(db, "booked_slots", slotId);

                await runTransaction(db, async (transaction) => {
                    const slotDoc = await transaction.get(slotRef);
                    if (slotDoc.exists()) { throw "Slot already booked"; }
                    
                    const bookingId = Math.floor(100000 + Math.random() * 900000).toString();
                    
                    const newAppointmentRef = doc(collection(db, "appointments"));
                    const appointmentData = { 
                        bookingId: bookingId, 
                        queueNumber: queueNumber,
                        patientName, 
                        patientContact, 
                        patientAge,
                        service: document.getElementById('service').value, 
                        treatmentRight: document.getElementById('treatment-right').value,
                        date: selectedDateForBooking, 
                        time: selectedTimeForBooking, 
                        status: 'pending', 
                        createdAt: serverTimestamp(), 
                        createdOnDate: new Date().toISOString().split('T')[0], 
                        note: "" 
                    };
                    transaction.set(newAppointmentRef, appointmentData);
                    transaction.set(slotRef, { appointmentId: newAppointmentRef.id });

                    const bookingDetailsContainer = document.getElementById('booking-details-display');
                    bookingDetailsContainer.innerHTML = `
                        <p><strong>รหัสจองคิว:</strong> <span class="font-mono text-lg font-bold text-indigo-600">${bookingId}</span></p>
                        <p><strong>หมายเลขคิว:</strong> <span class="font-bold text-lg">${queueNumber}</span></p>
                        <hr class="my-2 border-slate-200">
                        <p><strong>วันที่จอง:</strong> ${new Date(selectedDateForBooking + "T00:00:00").toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</p>
                        <p><strong>เวลา:</strong> ${selectedTimeForBooking} น.</p>
                        <p><strong>ชื่อ-สกุล:</strong> ${patientName}</p>
                        <p><strong>อายุ:</strong> ${patientAge} ปี</p>
                        <p><strong>เบอร์โทร:</strong> ${patientContact}</p>
                        <p><strong>ประเภทการรักษา:</strong> ${document.getElementById('service').value}</p>
                        <p><strong>สิทธิการรักษา:</strong> ${document.getElementById('treatment-right').value}</p>
                        <hr class="my-2 border-slate-200">
                        <p class="text-sm text-center text-slate-600 mt-4">กรุณามาตามวันและเวลาที่จอง<br>หากมีข้อสงสัย โทร. ${clinicConfig.contactPhone}</p>
                    `;
                });
                showView('confirmation-view');
                document.getElementById('booking-form').reset();
                selectedDateForBooking = null;
                selectedTimeForBooking = null;
            } catch (error) {
                if (error === "Slot already booked") {
                    msgEl.textContent = 'ขออภัย เวลานี้ถูกจองไปแล้ว กรุณาเลือกเวลาอื่น';
                } else {
                    msgEl.textContent = 'เกิดข้อผิดพลาดในการจองคิว';
                    console.error("Booking submission error:", error);
                }
            } finally {
                showLoading(false);
            }
        }
        async function handleStatusCheck(e) { e.preventDefault(); showLoading(true); const id = sanitizeHTML(document.getElementById('booking-id-input').value.trim()); const resultDiv = document.getElementById('status-result'); resultDiv.innerHTML = ''; if (!id) { resultDiv.innerHTML = `<p class="text-red-500 text-center font-semibold">กรุณากรอกรหัสการจอง</p>`; showLoading(false); return; } try { const q = query(collection(db, "appointments"), where("bookingId", "==", id)); const snap = await getDocs(q); if (!snap.empty) { const docSnap = snap.docs[0]; const appt = docSnap.data(); const statusInfo = getStatusInfo(appt.status); const slotId = `${appt.date}_${appt.time.replace(':', '-')}`; const cancelBtn = (appt.status === 'pending' || appt.status === 'confirmed') ? `<button id="patient-cancel-btn" data-id="${docSnap.id}" data-slot-id="${slotId}" class="w-full mt-4 bg-red-500 hover:bg-red-600 text-white py-2.5 rounded-lg transition font-semibold">ยกเลิกนัดหมาย</button>` : ''; resultDiv.innerHTML = `<div class="border rounded-xl p-4 ${statusInfo.bg} bg-opacity-20"><h4 class="font-bold text-lg text-slate-800">รายละเอียดการจอง</h4><p><strong>บริการ:</strong> ${sanitizeHTML(appt.service)}</p><p><strong>สิทธิการรักษา:</strong> ${sanitizeHTML(appt.treatmentRight || '-')}</p><p><strong>วันที่:</strong> ${new Date(appt.date + 'T00:00:00').toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})} เวลา ${appt.time} น.</p><div class="mt-2"><strong>สถานะ:</strong> <span class="text-sm font-medium px-2 py-1 rounded-full ${statusInfo.bg} ${statusInfo.text}">${translateStatus(appt.status)}</span></div></div>${cancelBtn}`; } else { resultDiv.innerHTML = `<p class="text-red-500 text-center font-semibold">ไม่พบข้อมูลการจองสำหรับรหัสนี้</p>`; } } catch (error) { resultDiv.innerHTML = `<p class="text-red-500 text-center font-semibold">เกิดข้อผิดพลาด</p>`; } finally { showLoading(false); } }
        async function handleSettingsSubmit(e) { 
            e.preventDefault(); 
            showLoading(true); 
            const newConfig = { 
                ...clinicConfig, 
                clinicName: sanitizeHTML(document.getElementById('clinic-name-input').value), 
                announcementBackup: announcementEditor.root.innerHTML,
                availableTimeSlots: clinicConfig.availableTimeSlots,
                operatingDays: Array.from(document.querySelectorAll('.operating-day-cb:checked')).map(cb => cb.value), 
                contactName: sanitizeHTML(document.getElementById('contact-name-input').value), 
                contactPhone: sanitizeHTML(document.getElementById('contact-phone-input').value) 
            }; 
            try { 
                await setDoc(doc(db, "clinic_settings", "config"), newConfig, { merge: true }); 
                clinicConfig = newConfig; 
                updatePublicUI(); 
                populateSettingsForm(); 
                alert('บันทึกการตั้งค่าสำเร็จ!'); 
            } catch (error) { 
                console.error("Error saving settings:", error);
                alert('เกิดข้อผิดพลาดในการบันทึก'); 
            } finally { 
                showLoading(false); 
            } 
        }
        async function handleContactSubmit(e) { e.preventDefault(); const form = e.target; const successMsg = document.getElementById('contact-form-success'); const senderContactInput = form.querySelector('#contact-sender-contact'); const phoneRegex = /^[0-9]{10}$/; if (!phoneRegex.test(senderContactInput.value)) { successMsg.textContent = 'กรุณากรอกเบอร์โทรศัพท์ 10 หลักให้ถูกต้อง'; successMsg.classList.remove('text-green-600'); successMsg.classList.add('text-red-500'); return; } successMsg.classList.remove('text-red-500'); successMsg.classList.add('text-green-600'); showLoading(true); try { await addDoc(collection(db, 'messages'), { senderName: sanitizeHTML(form.querySelector('#contact-sender-name').value), senderContact: sanitizeHTML(senderContactInput.value), message: sanitizeHTML(form.querySelector('#contact-message').value), createdAt: serverTimestamp(), }); form.reset(); successMsg.textContent = 'ส่งข้อความสำเร็จแล้ว'; setTimeout(() => { document.getElementById('contact-modal').classList.add('hidden'); successMsg.textContent = ''; }, 2000); } catch (error) { console.error("Error sending message:", error); successMsg.textContent = 'เกิดข้อผิดพลาดในการส่ง'; } finally { showLoading(false); } }
        async function handleNewsSubmit(e) {
            e.preventDefault();
            const title = document.getElementById('news-title').value;
            const content = newsEditor.root.innerHTML;
            if (!title.trim() || content.trim() === '<p><br></p>') {
                alert('กรุณากรอกหัวข้อและเนื้อหา');
                return;
            }
            showLoading(true);
            try {
                await addDoc(collection(db, 'news'), {
                    title: sanitizeHTML(title),
                    content: content,
                    createdAt: serverTimestamp()
                });
                e.target.reset();
                newsEditor.root.innerHTML = '';
            } catch (error) {
                console.error("Error adding news:", error);
                alert("เกิดข้อผิดพลาดในการเผยแพร่ข่าว");
            } finally {
                showLoading(false);
            }
        }
        function showView(viewId, updateHistory = true) {
            views.forEach(v => v.classList.remove('active'));
            const el = document.getElementById(viewId);
            if (el) el.classList.add('active');
            const isPreLogin = ['welcome-view', 'login-view', 'register-view', 'status-check-view', 'patient-booking-view', 'confirmation-view', 'news-board-view'].includes(viewId);
            document.getElementById('main-header').classList.toggle('hidden', isPreLogin);
            if (updateHistory) {
                const newUrl = `#${viewId}`;
                history.pushState({ view: viewId }, '', newUrl);
            }
        }
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.view) {
                showView(event.state.view, false);
            } else {
                showView('welcome-view', false);
            }
        });
        function goHome() {
            showView('welcome-view');
        }

        function resetAllForms() {
            if (document.getElementById('booking-form')) document.getElementById('booking-form').reset();
            if (document.getElementById('status-check-form')) document.getElementById('status-check-form').reset();
            if (document.getElementById('login-form')) document.getElementById('login-form').reset();
            if (document.getElementById('add-staff-form')) document.getElementById('add-staff-form').reset();
            if (document.getElementById('news-form')) document.getElementById('news-form').reset();
            if (document.getElementById('contact-form')) document.getElementById('contact-form').reset();
            
            selectedDateForBooking = null;
            selectedTimeForBooking = null;
            currentDate = new Date();
            if (clinicConfig) {
                 renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (unsubscribeAllAppointments) unsubscribeAllAppointments();
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeStaff) unsubscribeStaff();
            if (unsubscribeNews) unsubscribeNews();
            
            showLoading(true);
            if(user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists() && userDoc.data().role === 'staff') {
                    document.getElementById('admin-welcome').textContent = `สวัสดี, ${userDoc.data().fullName}`;
                    listenToAllAppointments();
                    listenToMessages();
                    listenToStaff();
                    listenToNews();
                    populateSettingsForm();
                    showView('admin-dashboard-view');
                } else {
                    await signOut(auth);
                }
            } else {
                resetAllForms();
                showView('welcome-view');
            }
            showLoading(false);
        });
        const showLoading = (isLoading) => loadingOverlay.classList.toggle('hidden', !isLoading);
        function getStatusInfo(status) { switch (status) { case 'pending': return { bg: 'bg-amber-100', text: 'text-amber-800' }; case 'confirmed': return { bg: 'bg-green-100', text: 'text-green-800' }; case 'completed': return { bg: 'bg-sky-100', text: 'text-sky-800' }; case 'cancelled': return { bg: 'bg-red-100', text: 'text-red-800' }; default: return { bg: 'bg-slate-100', text: 'text-slate-800' }; } }
        function translateStatus(status) { switch (status) { case 'pending': return 'รอการยืนยัน'; case 'confirmed': return 'ยืนยันแล้ว'; case 'completed': return 'เสร็จสิ้น'; case 'cancelled': return 'ยกเลิก'; default: return status; } }
        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }
        function exportToCsv() {
            const headers = ["Booking ID", "Patient Name", "Contact", "Service", "Treatment Right", "Date", "Time", "Status", "Note"];
            const rows = allAppointments.map(appt => [
                `"${appt.bookingId}"`,
                `"${appt.patientName}"`,
                `"${appt.patientContact}"`,
                `"${appt.service}"`,
                `"${appt.treatmentRight || ''}"`,
                `"${appt.date}"`,
                `"${appt.time}"`,
                `"${translateStatus(appt.status)}"`,
                `"${(appt.note || '').replace(/"/g, '""')}"`
            ]);

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF" // UTF-8 BOM
                + headers.join(",") + "\n" 
                + rows.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `clinic_report_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>


