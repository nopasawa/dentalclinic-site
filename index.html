<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองคิวคลินิกทันตกรรม</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .view { display: none; }
        .view.active { display: block; }
        .admin-view { display: none; }
        .admin-view.active { display: block; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Loading Spinner -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-white"></div>
        </div>
        
        <!-- Header for navigation -->
        <div id="main-header" class="mb-6 flex justify-between items-center hidden">
             <h1 class="clinic-name text-xl md:text-2xl font-bold text-indigo-600 cursor-pointer" id="home-button">คลินิกทันตกรรม</h1>
             <div id="header-actions"></div>
        </div>

        <!-- Welcome View -->
        <div id="welcome-view" class="view active text-center">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <h1 class="clinic-name text-3xl font-bold text-gray-800 mb-4">คลินิกทันตกรรมยินดีให้บริการ</h1>
                <!-- Announcement Section -->
                <div id="announcement-section" class="mb-8 p-4 bg-indigo-50 border border-indigo-200 rounded-lg hidden">
                    <h3 class="font-semibold text-indigo-800">ข่าวประชาสัมพันธ์</h3>
                    <p id="announcement-text" class="text-indigo-700"></p>
                </div>
                <p class="text-gray-600 mb-8">กรุณาเลือกบริการที่ต้องการ</p>
                <div class="flex flex-col md:flex-row gap-4 justify-center">
                    <button id="go-to-booking" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">จองคิวเข้ารับบริการ</button>
                    <button id="go-to-status-check" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">ตรวจสอบสถานะการจอง</button>
                    <button id="go-to-staff-login" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">สำหรับเจ้าหน้าที่</button>
                </div>
            </div>
        </div>

        <!-- Patient Booking View -->
        <div id="patient-booking-view" class="view">
             <div class="bg-white p-8 rounded-xl shadow-md max-w-lg mx-auto">
                <h2 class="text-2xl font-bold text-center text-indigo-600 mb-6">กรอกข้อมูลเพื่อจองคิว</h2>
                
                <div id="clinic-hours-info" class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-center">
                    <!-- Operating hours info will be populated by JS -->
                </div>
                
                <p id="booking-form-message" class="text-center text-red-500 mb-4"></p>

                <form id="booking-form" class="space-y-4">
                    <div>
                        <label for="patient-name" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล</label>
                        <input type="text" id="patient-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                     <div>
                        <label for="patient-contact" class="block text-sm font-medium text-gray-700">อีเมล หรือ เบอร์โทรศัพท์ (สำหรับแจ้งเตือน)</label>
                        <input type="text" id="patient-contact" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="service" class="block text-sm font-medium text-gray-700">เลือกบริการ</label>
                        <select id="service" name="service" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <!-- Services will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">วันที่</label>
                        <input type="date" id="date" name="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="time" class="block text-sm font-medium text-gray-700">เวลา</label>
                        <select id="time" name="time" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <!-- Time slots will be populated dynamically -->
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">ยืนยันการจอง</button>
                </form>
            </div>
        </div>
        
        <!-- Confirmation View -->
        <div id="confirmation-view" class="view text-center">
             <div class="bg-white p-8 rounded-xl shadow-md max-w-lg mx-auto">
                <svg class="mx-auto h-12 w-12 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="mt-6 text-2xl font-bold text-gray-800">จองคิวสำเร็จ!</h2>
                <p class="mt-2 text-gray-600">กรุณาเก็บรหัสการจองของท่านไว้เพื่อใช้ในการตรวจสอบสถานะ</p>
                <div class="mt-4 bg-gray-100 p-3 rounded-lg">
                    <p class="text-sm text-gray-500">รหัสการจองของคุณคือ:</p>
                    <p id="booking-id-display" class="text-lg font-mono font-bold text-indigo-600 break-words"></p>
                </div>
                 <button id="back-to-home-confirm" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">กลับสู่หน้าหลัก</button>
            </div>
        </div>

        <!-- Status Check View -->
        <div id="status-check-view" class="view">
             <div class="bg-white p-8 rounded-xl shadow-md max-w-lg mx-auto">
                <h2 class="text-2xl font-bold text-center text-green-600 mb-6">ตรวจสอบสถานะการจอง</h2>
                <form id="status-check-form" class="space-y-4">
                     <div>
                        <label for="booking-id-input" class="block text-sm font-medium text-gray-700">กรอกรหัสการจอง</label>
                        <input type="text" id="booking-id-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                    </div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">ตรวจสอบ</button>
                </form>
                <div id="status-result" class="mt-6"></div>
            </div>
        </div>

        <!-- Login View -->
        <div id="login-view" class="view">
             <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden mt-10">
                <div class="p-8">
                    <h2 class="text-2xl font-bold text-center text-indigo-600">เข้าสู่ระบบ (สำหรับเจ้าหน้าที่)</h2>
                    <form id="login-form" class="mt-8 space-y-6">
                        <div>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="อีเมล">
                        </div>
                        <div>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="รหัสผ่าน">
                        </div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">เข้าสู่ระบบ</button>
                    </form>
                    <p id="login-error" class="text-red-500 text-center mt-4 text-sm"></p>
                    <p class="mt-6 text-center text-sm text-gray-600">
                        <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">
                            สมัครสมาชิกสำหรับเจ้าหน้าที่
                        </a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Register View -->
        <div id="register-view" class="view">
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden mt-10">
                <div class="p-8">
                    <h2 class="text-2xl font-bold text-center text-indigo-600">สมัครสมาชิก (สำหรับเจ้าหน้าที่)</h2>
                    <form id="register-form" class="mt-8 space-y-6">
                        <div><input id="register-name" type="text" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="ชื่อ-นามสกุล"></div>
                        <div><input id="register-email" type="email" autocomplete="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="อีเมล"></div>
                        <div><input id="register-password" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)"></div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">สมัครสมาชิก</button>
                    </form>
                    <p id="register-error" class="text-red-500 text-center mt-4 text-sm"></p>
                    <p class="mt-6 text-center text-sm text-gray-600">
                        มีบัญชีอยู่แล้ว? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">เข้าสู่ระบบที่นี่</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard View -->
        <div id="admin-dashboard-view" class="view">
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Sidebar -->
                <aside class="md:w-64 bg-white p-6 rounded-xl shadow-md flex flex-col">
                    <h2 id="admin-welcome" class="text-lg font-bold text-gray-800 mb-6 truncate"></h2>
                    <nav class="flex-grow">
                        <ul class="space-y-2">
                            <li><a href="#" data-view="admin-appointments" class="admin-nav-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg bg-gray-200">ภาพรวมการนัดหมาย</a></li>
                            <li><a href="#" data-view="admin-settings" class="admin-nav-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100">ตั้งค่าคลินิก</a></li>
                        </ul>
                    </nav>
                     <button id="admin-logout" class="w-full mt-8 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">ออกจากระบบ</button>
                </aside>

                <!-- Main Content -->
                <main class="flex-1">
                    <!-- Appointments Content -->
                    <div id="admin-appointments-view" class="admin-view active">
                         <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4 text-indigo-600">รายการนัดหมายทั้งหมด</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                     <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสการจอง</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อคนไข้</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ข้อมูลติดต่อ</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">บริการ</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันและเวลา</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="all-appointments" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Settings Content -->
                    <div id="admin-settings-view" class="admin-view">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                             <h3 class="text-xl font-semibold mb-6 text-indigo-600">ตั้งค่าคลินิก</h3>
                             <form id="settings-form" class="space-y-8">
                                <!-- Clinic Info -->
                                <div class="space-y-4 border-b pb-6">
                                    <h4 class="font-medium">ข้อมูลทั่วไป</h4>
                                    <div>
                                        <label for="clinic-name-input" class="block text-sm font-medium text-gray-700">ชื่อคลินิก</label>
                                        <input type="text" id="clinic-name-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="announcement-input" class="block text-sm font-medium text-gray-700">ข่าวประชาสัมพันธ์</label>
                                        <textarea id="announcement-input" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                                    </div>
                                </div>
                                <!-- Operating Hours -->
                                <div class="space-y-4 border-b pb-6">
                                    <h4 class="font-medium">วันและเวลาทำการ</h4>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">วันที่เปิดให้บริการ</label>
                                        <div id="operating-days-inputs" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <!-- Checkboxes will be here -->
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="open-time-input" class="block text-sm font-medium text-gray-700">เวลาเปิด</label>
                                            <input type="time" id="open-time-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        </div>
                                        <div>
                                            <label for="close-time-input" class="block text-sm font-medium text-gray-700">เวลาปิด</label>
                                            <input type="time" id="close-time-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        </div>
                                    </div>
                                </div>
                                <!-- Services Management -->
                                <div class="space-y-4">
                                     <h4 class="font-medium">จัดการบริการ</h4>
                                     <div id="services-list" class="space-y-2"></div>
                                     <div class="flex gap-2">
                                         <input type="text" id="new-service-input" placeholder="เพิ่มบริการใหม่" class="flex-grow rounded-md border-gray-300 shadow-sm">
                                         <button type="button" id="add-service-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md">เพิ่ม</button>
                                     </div>
                                </div>
                                
                                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">บันทึกการตั้งค่า</button>
                             </form>
                        </div>
                    </div>
                </main>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, onSnapshot, updateDoc, serverTimestamp, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtOUoFJg_qcGdtMVgHLDAjK1gkk7rKQ7Q",
            authDomain: "demotest-ab5b5.firebaseapp.com",
            projectId: "demotest-ab5b5",
            storageBucket: "demotest-ab5b5.firebasestorage.app",
            messagingSenderId: "280787825559",
            appId: "1:280787825559:web:10f97a5c92578a6b8a4ad2",
            measurementId: "G-T1K3TMVXCV"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let clinicConfig = null;
        let unsubscribeAllAppointments = null;
        const DEFAULT_CONFIG = {
            clinicName: "คลินิกทันตกรรม",
            services: ["ตรวจสุขภาพฟัน", "ขูดหินปูน", "อุดฟัน"],
            operatingDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            operatingHours: { open: "09:00", close: "18:00" },
            announcement: ""
        };

        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const loadingOverlay = document.getElementById('loading-overlay');
        const serviceSelect = document.getElementById('service');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', loadClinicConfig);

        // --- Clinic Config Management ---
        async function loadClinicConfig() {
            showLoading(true);
            const configRef = doc(db, "clinic_settings", "config");
            const configSnap = await getDoc(configRef);
            if (configSnap.exists()) {
                clinicConfig = configSnap.data();
            } else {
                await setDoc(configRef, DEFAULT_CONFIG);
                clinicConfig = DEFAULT_CONFIG;
            }
            updatePublicUI();
            showLoading(false);
        }

        function updatePublicUI() {
            // Update clinic names
            document.querySelectorAll('.clinic-name').forEach(el => el.textContent = clinicConfig.clinicName);
            // Update announcement
            const announcementSection = document.getElementById('announcement-section');
            const announcementText = document.getElementById('announcement-text');
            if (clinicConfig.announcement && clinicConfig.announcement.trim() !== '') {
                announcementText.textContent = clinicConfig.announcement;
                announcementSection.classList.remove('hidden');
            } else {
                announcementSection.classList.add('hidden');
            }

            // Update operating hours info on booking page
            const hoursInfo = document.getElementById('clinic-hours-info');
            if (clinicConfig && hoursInfo) {
                const daysThai = { Monday:'จ.', Tuesday:'อ.', Wednesday:'พ.', Thursday:'พฤ.', Friday:'ศ.', Saturday:'ส.', Sunday:'อา.' };
                const openDays = clinicConfig.operatingDays.map(day => daysThai[day]).join(', ');
                
                hoursInfo.innerHTML = `
                    <p class="text-sm text-gray-700">
                        <span class="font-semibold">เวลาทำการ:</span> 
                        ${openDays || 'ไม่ระบุ'} 
                        <span class="font-mono">${clinicConfig.operatingHours.open} - ${clinicConfig.operatingHours.close}</span> น.
                    </p>
                `;
            }

            // Update services dropdown
            serviceSelect.innerHTML = clinicConfig.services.map(s => `<option>${s}</option>`).join('');

            // Setup date and time pickers with restrictions
            setupDateTimePickers();
        }

        function setupDateTimePickers() {
            if (!clinicConfig) return;

            const dateInput = document.getElementById('date');
            
            // Set min date to today to prevent booking in the past
            dateInput.min = new Date().toISOString().split('T')[0];

            // Add live validation for closed days
            dateInput.addEventListener('input', (e) => {
                const selectedDate = new Date(e.target.value);
                const dayIndex = selectedDate.getUTCDay(); 
                const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayIndex];

                if (e.target.value && !clinicConfig.operatingDays.includes(dayName)) {
                    e.target.value = ''; // Clear the invalid date
                    showBookingFormMessage('คลินิกปิดทำการในวันที่คุณเลือก กรุณาเลือกวันอื่นค่ะ');
                }
            });
            
            generateTimeSlots();
        }

        function generateTimeSlots() {
            const timeSelect = document.getElementById('time');
            timeSelect.innerHTML = '<option value="">-- เลือกเวลา --</option>';
            if (!clinicConfig) return;

            const { open, close } = clinicConfig.operatingHours;
            const [openHour, openMin] = open.split(':').map(Number);
            const [closeHour, closeMin] = close.split(':').map(Number);
            
            let currentHour = openHour;
            let currentMin = openMin;

            while (currentHour < closeHour || (currentHour === closeHour && currentMin < closeMin)) {
                const timeString = `${String(currentHour).padStart(2, '0')}:${String(currentMin).padStart(2, '0')}`;
                timeSelect.innerHTML += `<option value="${timeString}">${timeString}</option>`;
                
                currentMin += 30;
                if (currentMin >= 60) {
                    currentHour++;
                    currentMin -= 60;
                }
            }
        }

        function showBookingFormMessage(message, isError = true) {
            const messageEl = document.getElementById('booking-form-message');
            messageEl.textContent = message;
            messageEl.className = `text-center mb-4 ${isError ? 'text-red-500' : 'text-green-600'}`;
            setTimeout(() => {
                messageEl.textContent = '';
            }, 4000); // Message disappears after 4 seconds
        }

        // --- View Management ---
        const showView = (viewId) => {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            const isPreLogin = ['welcome-view', 'login-view', 'register-view'].includes(viewId);
            document.getElementById('main-header').classList.toggle('hidden', isPreLogin);
        };
        const showLoading = (isLoading) => loadingOverlay.classList.toggle('hidden', !isLoading);

        function goHome() {
            if (auth.currentUser) {
                signOut(auth).catch(error => console.error("Sign out error:", error));
            }
            showView('welcome-view');
        }

        // --- Auth State ---
        onAuthStateChanged(auth, async (user) => {
            showLoading(true);
            if (unsubscribeAllAppointments) unsubscribeAllAppointments();

            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists() && userDoc.data().role === 'staff') {
                        setupAdminDashboard(userDoc.data());
                        showView('admin-dashboard-view');
                    } else {
                        await signOut(auth);
                        showView('welcome-view');
                    }
                } catch (error) {
                    console.error("Auth state change error:", error);
                    await signOut(auth);
                    showView('welcome-view');
                }
            } else {
                showView('welcome-view');
            }
            showLoading(false);
        });
        
        // --- Staff Auth Logic ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading(true);
            loginError.textContent = '';
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    loginError.textContent = "อีเมลหรือรหัสผ่านไม่ถูกต้อง";
                })
                .finally(() => showLoading(false));
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading(true);
            registerError.textContent = '';
            const name = registerForm['register-name'].value;
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(userCredential => {
                    return setDoc(doc(db, "users", userCredential.user.uid), {
                        fullName: name,
                        email: email,
                        role: 'staff'
                    });
                })
                .catch(error => {
                    registerError.textContent = "เกิดข้อผิดพลาดในการสมัครสมาชิก";
                })
                .finally(() => showLoading(false));
        });
        
        // --- Patient Booking Logic ---
        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedDateValue = document.getElementById('date').value;
            const selectedTimeValue = document.getElementById('time').value;

            if (!selectedDateValue || !selectedTimeValue) {
                showBookingFormMessage('กรุณาเลือกวันและเวลาที่ต้องการจอง');
                return;
            }

            showLoading(true);
            try {
                // Check for double booking
                const q = query(collection(db, "appointments"), 
                    where("date", "==", selectedDateValue), 
                    where("time", "==", selectedTimeValue),
                    where("status", "in", ["pending", "confirmed"])
                );
                const existingApptSnapshot = await getDocs(q);

                if (!existingApptSnapshot.empty) {
                    showBookingFormMessage('ขออภัย เวลานี้ถูกจองแล้ว กรุณาเลือกเวลาอื่นค่ะ');
                    showLoading(false);
                    return;
                }

                // If slot is available, proceed to book
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const buddhistYear = now.getFullYear() + 543;
                const yearShort = String(buddhistYear).slice(-2);
                const datePrefix = `${day}${month}${yearShort}`;
                const todayStringForQuery = now.toISOString().split('T')[0];
                const qRunNumber = query(collection(db, "appointments"), where("createdOnDate", "==", todayStringForQuery));
                const querySnapshot = await getDocs(qRunNumber);
                const runNumber = String(querySnapshot.size).padStart(2, '0');
                const newBookingId = `${datePrefix}-${runNumber}`;

                await addDoc(collection(db, "appointments"), {
                    bookingId: newBookingId,
                    patientName: document.getElementById('patient-name').value,
                    patientContact: document.getElementById('patient-contact').value,
                    service: serviceSelect.value,
                    date: selectedDateValue,
                    time: selectedTimeValue,
                    status: 'pending',
                    createdAt: serverTimestamp(),
                    createdOnDate: todayStringForQuery
                });
                document.getElementById('booking-id-display').textContent = newBookingId;
                showView('confirmation-view');
            } catch (error) {
                console.error("Booking error:", error);
                showBookingFormMessage("เกิดข้อผิดพลาดในการจองคิว");
            } finally {
                showLoading(false);
            }
        });

        // --- Status Check Logic ---
        document.getElementById('status-check-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const customBookingId = document.getElementById('booking-id-input').value.trim();
            const statusResultDiv = document.getElementById('status-result');
            statusResultDiv.innerHTML = '';

            if (!customBookingId) {
                statusResultDiv.innerHTML = `<p class="text-red-500">กรุณากรอกรหัสการจอง</p>`;
                showLoading(false);
                return;
            }

            try {
                const q = query(collection(db, "appointments"), where("bookingId", "==", customBookingId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const docSnap = querySnapshot.docs[0];
                    const appt = docSnap.data();
                    const statusInfo = getStatusInfo(appt.status);
                    statusResultDiv.innerHTML = `
                        <div class="border rounded-lg p-4 ${statusInfo.bg} bg-opacity-20">
                            <h4 class="font-bold text-lg">รายละเอียดการจอง</h4>
                            <p><strong>บริการ:</strong> ${appt.service}</p>
                            <p><strong>วันที่:</strong> ${new Date(appt.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})} เวลา ${appt.time} น.</p>
                            <div class="mt-2">
                                <strong>สถานะ:</strong>
                                <span class="text-sm font-medium px-2 py-1 rounded-full ${statusInfo.bg} ${statusInfo.text}">${translateStatus(appt.status)}</span>
                            </div>
                        </div>
                    `;
                } else {
                    statusResultDiv.innerHTML = `<p class="text-red-500">ไม่พบข้อมูลการจองสำหรับรหัสนี้</p>`;
                }
            } catch (error) {
                console.error("Status check error:", error);
                statusResultDiv.innerHTML = `<p class="text-red-500">เกิดข้อผิดพลาดในการตรวจสอบข้อมูล</p>`;
            } finally {
                showLoading(false);
            }
        });


        // --- Admin Dashboard Logic ---
        function setupAdminDashboard(adminData) {
            document.getElementById('admin-welcome').textContent = `สวัสดี, ${adminData.fullName}`;
            populateSettingsForm();
            listenToAllAppointments();
            
            document.querySelectorAll('.admin-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('bg-gray-200'));
                    link.classList.add('bg-gray-200');
                    const viewId = link.dataset.view + '-view';
                    document.querySelectorAll('.admin-view').forEach(v => v.classList.remove('active'));
                    document.getElementById(viewId).classList.add('active');
                });
            });
            document.getElementById('admin-logout').addEventListener('click', () => signOut(auth));
        }

        // --- Settings Page Logic ---
        function populateSettingsForm() {
            if (!clinicConfig) return;
            document.getElementById('clinic-name-input').value = clinicConfig.clinicName;
            document.getElementById('announcement-input').value = clinicConfig.announcement;
            document.getElementById('open-time-input').value = clinicConfig.operatingHours.open;
            document.getElementById('close-time-input').value = clinicConfig.operatingHours.close;
            
            const daysContainer = document.getElementById('operating-days-inputs');
            const days = { Monday:'จันทร์', Tuesday:'อังคาร', Wednesday:'พุธ', Thursday:'พฤหัสบดี', Friday:'ศุกร์', Saturday:'เสาร์', Sunday:'อาทิตย์' };
            daysContainer.innerHTML = Object.entries(days).map(([eng, th]) => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" value="${eng}" class="operating-day-cb rounded" ${clinicConfig.operatingDays.includes(eng) ? 'checked' : ''}>
                    <span>${th}</span>
                </label>
            `).join('');

            renderServicesList();
        }

        function renderServicesList() {
            const listContainer = document.getElementById('services-list');
            listContainer.innerHTML = clinicConfig.services.map((service, index) => `
                <div class="flex items-center justify-between p-2 border rounded-md">
                    <input type="text" value="${service}" data-index="${index}" class="service-item-input border-0 focus:ring-0 w-full">
                    <button type="button" data-index="${index}" class="delete-service-btn text-red-500 hover:text-red-700">ลบ</button>
                </div>
            `).join('');
        }
        
        document.getElementById('add-service-btn').addEventListener('click', () => {
            const input = document.getElementById('new-service-input');
            if (input.value.trim()) {
                clinicConfig.services.push(input.value.trim());
                input.value = '';
                renderServicesList();
            }
        });
        
        document.getElementById('services-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-service-btn')) {
                const index = e.target.dataset.index;
                clinicConfig.services.splice(index, 1);
                renderServicesList();
            }
        });
        
        document.getElementById('services-list').addEventListener('change', (e) => {
             if (e.target.classList.contains('service-item-input')) {
                const index = e.target.dataset.index;
                clinicConfig.services[index] = e.target.value.trim();
            }
        });

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            
            const newConfig = {
                clinicName: document.getElementById('clinic-name-input').value,
                announcement: document.getElementById('announcement-input').value,
                operatingHours: {
                    open: document.getElementById('open-time-input').value,
                    close: document.getElementById('close-time-input').value,
                },
                operatingDays: Array.from(document.querySelectorAll('.operating-day-cb:checked')).map(cb => cb.value),
                services: clinicConfig.services.filter(s => s && s.trim() !== '')
            };

            try {
                await setDoc(doc(db, "clinic_settings", "config"), newConfig);
                clinicConfig = newConfig;
                updatePublicUI();
                alert('บันทึกการตั้งค่าสำเร็จ!');
            } catch (error) {
                console.error("Error saving settings:", error);
                alert('เกิดข้อผิดพลาดในการบันทึก');
            } finally {
                showLoading(false);
            }
        });

        function listenToAllAppointments() { 
            const allAppointmentsContainer = document.getElementById('all-appointments');
            const q = query(collection(db, "appointments"));
            unsubscribeAllAppointments = onSnapshot(q, (querySnapshot) => {
                let html = '';
                if (querySnapshot.empty) {
                    allAppointmentsContainer.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">ไม่พบรายการนัดหมาย</td></tr>';
                    return;
                }
                const appointments = [];
                querySnapshot.forEach(doc => appointments.push({ id: doc.id, ...doc.data() }));

                appointments.sort((a, b) => {
                    const dateA = new Date(`${a.date}T${a.time}`);
                    const dateB = new Date(`${b.date}T${b.time}`);
                    return dateB - dateA;
                });
                
                appointments.forEach((appt) => {
                    const statusInfo = getStatusInfo(appt.status);
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-700">${appt.bookingId || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${appt.patientName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${appt.patientContact}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${appt.service}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(appt.date).toLocaleDateString('th-TH')} ${appt.time}</td>
                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.bg} ${statusInfo.text}">${translateStatus(appt.status)}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-id="${appt.id}" data-status="confirmed" class="update-status-btn text-green-600 hover:text-green-900 ${appt.status !== 'pending' ? 'hidden' : ''}">ยืนยัน</button>
                                <button data-id="${appt.id}" data-status="completed" class="update-status-btn text-blue-600 hover:text-blue-900 ${appt.status !== 'confirmed' ? 'hidden' : ''}">เสร็จสิ้น</button>
                                <button data-id="${appt.id}" data-status="cancelled" class="update-status-btn text-red-600 hover:text-red-900 ${['completed', 'cancelled'].includes(appt.status) ? 'hidden' : ''}">ยกเลิก</button>
                            </td>
                        </tr>
                    `;
                });
                allAppointmentsContainer.innerHTML = html;
            });
        }
        
        document.getElementById('all-appointments').addEventListener('click', (e) => {
            if (e.target.classList.contains('update-status-btn')) {
                updateDoc(doc(db, "appointments", e.target.dataset.id), { status: e.target.dataset.status });
            }
        });
        
        // --- Navigation Event Listeners ---
        document.getElementById('go-to-booking').addEventListener('click', () => showView('patient-booking-view'));
        document.getElementById('go-to-status-check').addEventListener('click', () => {
            document.getElementById('status-result').innerHTML = '';
            document.getElementById('status-check-form').reset();
            showView('status-check-view');
        });
        document.getElementById('go-to-staff-login').addEventListener('click', () => showView('login-view'));
        document.getElementById('home-button').addEventListener('click', goHome);
        document.getElementById('back-to-home-confirm').addEventListener('click', goHome);
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); showView('register-view'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showView('login-view'); });

        // --- Helper Functions ---
        function getStatusInfo(status) {
            switch (status) {
                case 'pending': return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
                case 'confirmed': return { bg: 'bg-green-100', text: 'text-green-800' };
                case 'completed': return { bg: 'bg-blue-100', text: 'text-blue-800' };
                case 'cancelled': return { bg: 'bg-red-100', text: 'text-red-800' };
                default: return { bg: 'bg-gray-100', text: 'text-gray-800' };
            }
        }
        
        function translateStatus(status) {
            switch (status) {
                case 'pending': return 'รอการยืนยัน';
                case 'confirmed': return 'ยืนยันแล้ว';
                case 'completed': return 'เสร็จสิ้น';
                case 'cancelled': return 'ยกเลิก';
                default: return status;
            }
        }

    </script>
</body>
</html>

